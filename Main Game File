import pygame, sys, math, time, random
from pygame.locals import *
pygame.init()
vec = pygame.math.Vector2


WIDTH, HEIGHT = 1280, 720

displaysurface = pygame.display.set_mode((WIDTH, HEIGHT), pygame.RESIZABLE)
pygame.display.set_caption("Game")
t0 = time.time()
shot = False

clock = clock = pygame.time.Clock()

WHITE = (255, 255, 255)
BLUE = (0, 0, 255)

class Player(pygame.sprite.Sprite):
    def __init__(self, x, y, width, height, vel, grav, friction):
        super().__init__()
        self.pos = vec(x, y)
        self.velocity = vel
        self.acc = vec(0, grav)
        self.vel = vec(0, 0)
        self.width = width
        self.height = height
        self.surf = pygame.Surface((width,height))
        self.surf.fill((128,255,40))
        self.rect = self.surf.get_rect()
        self.friction = friction
    def move(self):
        pressed_keys = pygame.key.get_pressed()
        if pressed_keys[K_LEFT] or pressed_keys[K_a]:
            self.acc.x = -self.velocity
        if pressed_keys[K_RIGHT] or pressed_keys[K_d]:
            self.acc.x = self.velocity
        self.acc.x += self.vel.x * self.friction
        self.vel.y += self.acc.y
        self.vel.x = self.acc.x
        self.pos += self.vel + 0.5 * self.acc
        self.rect.midbottom = self.pos
    def update(self):
        hits = pygame.sprite.spritecollide(self, platforms, False)
        if hits:
            self.pos.y = hits[0].rect.top + 1
            self.vel.y = 0
    def jump(self):
        hits_platform = pygame.sprite.spritecollide(self, platforms, False)
        if hits_platform:
            self.vel.y = -HEIGHT / 52
class Platform(pygame.sprite.Sprite):
    def __init__(self):
        super().__init__()
        self.surf = pygame.Surface((WIDTH, HEIGHT / 20))
        self.surf.fill((255, 0, 0))
        self.rect = self.surf.get_rect(center = (WIDTH/2, HEIGHT - 10))
class Bullet(pygame.sprite.Sprite):
    def __init__(self, x, y, t0, width, height, grav, velx, vely):
        super().__init__()
        self.pos = vec(x, y)
        self.t0 = t0
        self.direction = math.atan2(mouse_pos.y - player.pos.y, mouse_pos.x - player.pos.x)
        self.surf = pygame.Surface((width,height))
        self.rect = self.surf.get_rect()
        self.surf.fill(WHITE)
        self.kill = False
        self.grav = grav
        self.vel = vec(velx, vely)
    def update(self):
        hits_enemy = pygame.sprite.spritecollide(self, enemies, True)
        hits_platform = pygame.sprite.spritecollide(self, platforms, False)
        self.pos.x += math.cos(self.direction) * self.vel.x
        self.pos.y += math.sin(self.direction) * self.vel.y + .5*self.grav*(2*(time.time() - self.t0)**2)
    def render(self):
        self.rect.midbottom = self.pos
class Enemy(pygame.sprite.Sprite):
    def __init__(self, x, y, width, height, vel, grav, friction):
        super().__init__()
        self.pos = vec(x, y)
        self.acc = vec(0, grav)
        self.surf = pygame.Surface((width, height))
        self.rect = self.surf.get_rect()
        self.surf.fill(BLUE)
        self.velocity = vel
        self.vel = vec(0,0)
        self.friction = friction
    def update(self):
        hits_platform = pygame.sprite.spritecollide(self, platforms, False)
        hits_player = pygame.sprite.spritecollide(self, players, True)
        if self.vel.y > 0:
            if hits_platform:
                self.pos.y = hits_platform[0].rect.top + 1
                self.vel.y = 0
        if player.pos.x > self.pos.x:
            self.acc.x = (self.velocity - 0.5)
        if player.pos.x < self.pos.x:
            self.acc.x = (-self.velocity + 0.5)
        self.acc.x += self.vel.x * self.friction
        self.vel.y += self.acc.y
        self.vel.x = self.acc.x
        self.pos += self.vel + 0.5 * self.acc
        self.rect.midbottom = self.pos

players = pygame.sprite.Group()
platforms = pygame.sprite.Group()
bullets = pygame.sprite.Group()
enemies = pygame.sprite.Group()

player = Player(x = WIDTH / 13, y = HEIGHT / 1.8, width = WIDTH / 43, height =  HEIGHT / 24, vel = WIDTH / 256, grav = HEIGHT / 1440, friction = -WIDTH / 10667)
platform = Platform()
enemy = Enemy(x= WIDTH / 2.7, y =  HEIGHT / 1.8, width =  WIDTH / 43, height = HEIGHT / 24, vel = WIDTH / 290, grav = HEIGHT / 1440, friction =  -WIDTH / 10667)

players.add(player)
platforms.add(platform)
enemies.add(enemy)

def newbullet():
    bullet = Bullet(player.pos.x, player.pos.y - (player.height / 2), time.time(), width = WIDTH / 426, height = HEIGHT / 240, grav = HEIGHT / 48, velx = WIDTH / 128, vely = HEIGHT / 72)
    bullets.add(bullet)

while True:
    displaysurface.fill((0,0,0))
    clock.tick(60)
    mouse_y, mouse_x = pygame.mouse.get_pos()
    mouse_pos = vec(mouse_y, mouse_x)
    for event in pygame.event.get():
        if event.type == QUIT:
            pygame.quit()
            sys.exit()
        if event.type == pygame.KEYDOWN:
            if event.key == pygame.K_SPACE:
                for player in players:
                    player.jump()
        if event.type == MOUSEBUTTONDOWN and event.button == 1:
            shoot = True
            newbullet()
    for player in players:
        displaysurface.blit(player.surf, player.rect)
        player.move()
        player.update()
    for platform in platforms:
        displaysurface.blit(platform.surf, platform.rect)
    for enemy in enemies:
        displaysurface.blit(enemy.surf, enemy.rect)
        enemy.update()
    for bullet in bullets:
        bullet.update()
        bullet.render()
        displaysurface.blit(bullet.surf, bullet.rect)
    pygame.display.update()    

    
